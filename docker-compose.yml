services:
    openclaw-gateway:
        image: ${OPENCLAW_IMAGE:-openclaw:local}
        environment:
            HOME: /home/node
            TERM: xterm-256color
            OPENCLAW_GATEWAY_URL: ws://127.0.0.1:18789
            OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
            CLAUDE_AI_SESSION_KEY: ${CLAUDE_AI_SESSION_KEY}
            CLAUDE_WEB_SESSION_KEY: ${CLAUDE_WEB_SESSION_KEY}
            CLAUDE_WEB_COOKIE: ${CLAUDE_WEB_COOKIE}
            SLACK_BOT_TOKEN: ${SLACK_BOT_TOKEN}
            SLACK_APP_TOKEN: ${SLACK_APP_TOKEN}
        volumes:
            - ${OPENCLAW_CONFIG_DIR}:/home/node/.openclaw
            - ${OPENCLAW_WORKSPACE_DIR}:/home/node/.openclaw/workspace
        ports:
            - "${OPENCLAW_GATEWAY_PORT:-18789}:18789"
            - "${OPENCLAW_BRIDGE_PORT:-18790}:18790"
        init: true
        restart: unless-stopped
        command:
            [
                "node",
                "dist/index.js",
                "gateway",
                "--bind",
                "lan",
                "--port",
                "18789",
                "--token",
                "${OPENCLAW_GATEWAY_TOKEN}",
            ]

    openclaw-cli:
        image: ${OPENCLAW_IMAGE:-openclaw:local}
        environment:
            HOME: /home/node
            TERM: xterm-256color
            OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
            OPENCLAW_GATEWAY_BIND: lan
            BROWSER: echo
            CLAUDE_AI_SESSION_KEY: ${CLAUDE_AI_SESSION_KEY}
            CLAUDE_WEB_SESSION_KEY: ${CLAUDE_WEB_SESSION_KEY}
            CLAUDE_WEB_COOKIE: ${CLAUDE_WEB_COOKIE}
            ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
        volumes:
            - ${OPENCLAW_CONFIG_DIR}:/home/node/.openclaw
            - ${OPENCLAW_WORKSPACE_DIR}:/home/node/.openclaw/workspace
        stdin_open: true
        tty: true
        init: true
        entrypoint: ["node", "dist/index.js"]

    openclaw-sandbox-browser:
        image: openclaw-browser:local
        networks:
            default:
                ipv4_address: 172.26.0.10
        environment:
            OPENCLAW_BROWSER_CDP_PORT: 9222
            OPENCLAW_BROWSER_VNC_PORT: 5900
            OPENCLAW_BROWSER_NOVNC_PORT: 6080
            OPENCLAW_BROWSER_ENABLE_NOVNC: 0
            OPENCLAW_BROWSER_HEADLESS: 1
        ports:
            - "9222:9222"
        init: true
        restart: unless-stopped
        healthcheck:
            test:
                [
                    "CMD",
                    "curl",
                    "-sf",
                    "--max-time",
                    "5",
                    "http://127.0.0.1:9222/json/version",
                ]
            interval: 60s
            timeout: 10s
            retries: 3
            start_period: 30s

    autoheal:
        image: willfarrell/autoheal
        environment:
            AUTOHEAL_CONTAINER_LABEL: all
            AUTOHEAL_INTERVAL: 60
            AUTOHEAL_START_PERIOD: 120
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
        restart: unless-stopped

networks:
    default:
        ipam:
            config:
                - subnet: 172.26.0.0/24
